{% extends "base.html" %} {% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='assets/css/edit_profile.css') }}" />
{% endblock %} {% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <!-- Account -->
            <div class="card mt-4">
                <div class="card-header">
                    <h4 class="mb-0">Account</h4>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data" id="profileForm">
                        <input type="hidden" name="csrf_token" id="csrfTokenField" value="{{ csrf_token }}">
                        <div class="row mb-4" style="gap: 0;display: flex;align-items: flex-start;">
                            <div class="col-md-6">
                                <div id="user-picture">
                                    <span id="profile-pic-preview"
                                        style="cursor: pointer; position: relative; display: inline-block;"
                                        onclick="document.getElementById('profile-picture-input').click();">
                                        {% if user.profilePicture %}
                                        <img src="{{ user.profilePicture }}" alt="Profile Picture"
                                            class="rounded-circle mb-3 profile-pic-img"
                                            style="width: 120px; height: 120px; object-fit: cover;">
                                        {% else %}
                                        <span
                                            class="d-inline-flex align-items-center justify-content-center rounded-circle mb-3 profile-pic-img"
                                            style="width: 120px; height: 120px; background: #23263a; color: #bfc7d5; font-size: 2.5rem; border: 2px solid #343a40;">
                                            <i class="fas fa-user"></i>
                                        </span>
                                        {% endif %}
                                        <span class="change-pic-icon">
                                            <i class="fas fa-camera"></i>
                                        </span>
                                    </span>
                                    <div style="display: flex;flex-direction: column;">
                                        <span id="profile-pic-filename"></span>
                                        <input type="file" id="profile-picture-input" name="profile_picture"
                                            accept="image/*" class="form-control mt-2"
                                            style="max-width: 250px; margin: 0 auto; display: none;"
                                            onchange="previewProfilePicture(this)">
                                        <small class="text-muted">Upload a new profile picture</small>
                                        {% if user.profilePicture %}
                                        <button type="button" class="btn btn-outline-danger btn-sm mt-2"
                                            id="removeProfilePicBtn" style="width: fit-content;">Remove Profile
                                            Picture</button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 d-flex align-items-center">
                                <div id="user-member-since" class="w-100">
                                    <label class="form-label text-muted">Member Since</label>
                                    <p class="mb-0">{{ user.createdAt.strftime('%B %d, %Y') if user.createdAt else
                                        'Unknown' }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Display Name -->
                        <div id="user-name" class="mb-3">
                            <label for="display_name" class="form-label">Display Name</label>
                            <input type="text" class="form-control" id="display_name" name="display_name"
                                value="{{ user.username }}" maxlength="50" required>
                            <div class="form-text">This is how your name will appear to others.</div>
                        </div>

                        <!-- Bio -->
                        <div class="mb-3">
                            <label for="bio" class="form-label">Bio</label>
                            <textarea class="form-control" id="bio" name="bio" rows="3" maxlength="500"
                                placeholder="Tell people about yourself...">{{ user.bio or '' }}</textarea>
                            <div class="form-text">
                                <span id="bio-count">{{ (user.bio or '')|length }}</span>/500 characters
                            </div>
                        </div>

                        <!-- Email -->
                        <div class="mb-3">
                            <label for="display_email" class="form-label">Email</label>
                            <div class="input-group">
                                <input type="email" class="form-control" id="edit_email" name="edit_email"
                                    value="{{ user.email }}" maxlength="100" readonly>
                                <button type="button" class="btn card-btn-primary" id="updateEmailBtn"
                                    data-bs-toggle="modal" data-bs-target="#updateEmailModal">Update Email</button>
                            </div>
                        </div>

                        <!-- Update Email Modal -->
                        <div class="modal fade" id="updateEmailModal" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Update Email</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <!-- Email Input Section -->
                                        <div id="email-input-section">
                                            <div class="mb-3">
                                                <label for="current_email_display" class="form-label text-muted">Current
                                                    Email</label>
                                                <input type="email" class="form-control" id="current_email_display"
                                                    value="{{ user.email }}" readonly>
                                            </div>
                                            <div class="mb-3">
                                                <label for="new_email" class="form-label">New Email Address</label>
                                                <input type="email" class="form-control" id="new_email" name="new_email"
                                                    placeholder="Enter new email address">
                                                <div class="form-text">A verification code will be sent to this email
                                                    address.</div>
                                            </div>
                                            <button type="button" class="base-btn base-btn-primary"
                                                id="sendEmailOtpBtn">Send Verification Code</button>
                                        </div>

                                        <!-- OTP Verification Section -->
                                        <div id="email-otp-section" style="display: none;">
                                            <div class="alert alert-info">
                                                <i class="fas fa-envelope"></i>
                                                We've sent a verification code to <span id="otp-target-email"></span>
                                            </div>
                                            <div class="mb-3">
                                                <label for="email_otp_code" class="form-label">Verification Code</label>
                                                <input type="text" class="form-control" id="email_otp_code"
                                                    maxlength="6" placeholder="Enter OTP code">
                                            </div>
                                            <div class="d-flex gap-2">
                                                <button type="button" class="btn btn-success"
                                                    id="verifyEmailOtpBtn">Update Email</button>
                                                <button type="button" class="btn btn-outline-secondary"
                                                    id="backToEmailInputBtn">Back</button>
                                                <button type="button" class="btn btn-outline-primary"
                                                    id="resendEmailOtpBtn">Resend Code</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Visibility -->
                        <div class="mb-4">
                            <label for="visibility" class="form-label">Profile Visibility</label>
                            <select class="form-select" id="visibility" name="visibility">
                                <option value="Public" {% if user.visibility=='Public' %}selected{% endif %}>
                                    Public - Anyone can see your profile and posts
                                </option>
                                <option value="FollowersOnly" {% if user.visibility=='FollowersOnly' %}selected{% endif
                                    %}>
                                    Followers Only - Only your followers can see your posts
                                </option>
                                <option value="Private" {% if user.visibility=='Private' %}selected{% endif %}>
                                    Private - Your posts are hidden from everyone
                                </option>
                            </select>
                        </div>

                        <!-- Buttons -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('profile.profile') }}" class="base-btn base-btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back to Profile
                            </a>
                            <button type="submit" class="base-btn base-btn-primary">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Security Settings -->
            <div class="card mt-4">
                <div class="card-header">
                    <h4 class="mb-0">Security Settings</h4>
                </div>
                <div class="card-body">
                    <!-- OTP Setting -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Two-Factor Authentication (OTP)</h6>
                                <small class="text-muted">Enable email-based OTP for secure login</small>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="otpToggle" {% if user.otp_enabled
                                    %}checked{% endif %}>
                                <label class="form-check-label" for="otpToggle"></label>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-info">
                                <i class="fas fa-info-circle"></i>
                                When enabled, you'll receive a 6-digit code via email during login.
                            </small>
                        </div>
                    </div>

                    <hr>

                    <!-- Change Password Button -->
                    <button class="btn btn-outline-warning btn-sm mb-3" data-bs-toggle="collapse"
                        data-bs-target="#passwordChangeForm" aria-expanded="false">
                        <i class="fas fa-key"></i> Change Password
                    </button>

                    <!-- Password Change Form (Initially Hidden) -->
                    <div class="collapse" id="passwordChangeForm">
                        <div class="card card-body">
                            <form id="changePasswordForm">
                                <div class="mb-3">
                                    <label for="current_password" class="form-label">Current Password</label>
                                    <input type="password" class="form-control" id="current_password"
                                        name="current_password" required>
                                </div>
                                <div class="mb-3">
                                    <label for="new_password" class="form-label">New Password</label>
                                    <input type="password" class="form-control" id="new_password" name="new_password"
                                        minlength="6" required>
                                    <div class="form-text">Password must be at least 8 characters long.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="confirm_password" class="form-label">Confirm New Password</label>
                                    <input type="password" class="form-control" id="confirm_password"
                                        name="confirm_password" minlength="6" required>
                                </div>
                                <div class="mb-3" id="passwordOtpSection"
                                    style="display: {% if user.otp_enabled %}block{% else %}none{% endif %};">
                                    <label for="password_otp_code" class="form-label">OTP Code</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="password_otp_code" name="otp_code"
                                            placeholder="Enter OTP code" {% if user.otp_enabled %}required{% endif %}>
                                        <button type="button" class="btn btn-outline-secondary" id="sendPasswordOtpBtn">
                                            <i class="fas fa-envelope"></i> Send OTP
                                        </button>
                                    </div>
                                    <div class="form-text">OTP required for password change when MFA is enabled.</div>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-secondary" data-bs-toggle="collapse"
                                        data-bs-target="#passwordChangeForm">
                                        Cancel
                                    </button>
                                    <button type="submit" class="btn btn-warning">
                                        <i class="fas fa-key"></i> Change Password
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Other Options -->
                    <div class="mt-3">
                        <button class="btn btn-outline-danger btn-sm" data-bs-toggle="collapse"
                            data-bs-target="#deleteAccountForm" aria-expanded="false">
                            <i class="fas fa-trash"></i> Delete Account
                        </button>
                    </div>

                    <!-- Delete Account Form (Initially Hidden) -->
                    <div class="collapse mt-3" id="deleteAccountForm">
                        <div class="card card-body border-danger">
                            <div class="alert alert-danger" role="alert">
                                <h6 class="alert-heading">⚠️ Danger Zone</h6>
                                <p class="mb-0">This action cannot be undone. This will permanently delete your account
                                    and remove all your data from our servers.</p>
                            </div>
                            <form id="deleteAccountForm">
                                <div class="mb-3">
                                    <label for="delete_password" class="form-label">Enter your password to
                                        confirm</label>
                                    <input type="password" class="form-control" id="delete_password" name="password"
                                        required>
                                </div>
                                <div class="mb-3">
                                    <label for="confirm_deletion" class="form-label">Type <strong>DELETE</strong> to
                                        confirm</label>
                                    <input type="text" class="form-control" id="confirm_deletion"
                                        name="confirm_deletion" placeholder="Type DELETE here" required>
                                    <div class="form-text">You must type "DELETE" exactly as shown above.</div>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-secondary" data-bs-toggle="collapse"
                                        data-bs-target="#deleteAccountForm">
                                        Cancel
                                    </button>
                                    <button type="submit" class="btn btn-danger" id="deleteAccountBtn" disabled>
                                        <i class="fas fa-trash"></i> Delete My Account
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="{{ url_for('static', filename='assets/js/csrf.js') }}"></script>
<script>

    document.addEventListener('DOMContentLoaded', function () {
    fetch('/get-csrf-token')
        .then(res => res.json())
        .then(data => {
            document.getElementById('csrfTokenField').value = data.csrf_token;
        })
        .catch(err => {
            console.error('Failed to fetch CSRF token:', err);
        });
    });
    // Profile picture preview function
    function previewProfilePicture(input) {
        const file = input.files[0];
        const filenameDisplay = document.getElementById('profile-pic-filename');
        const previewContainer = document.getElementById('profile-pic-preview');

        if (file) {
            // Update filename display with truncation for long names
            let displayName = file.name;
            if (displayName.length > 30) {
                const extension = displayName.substring(displayName.lastIndexOf('.'));
                const nameWithoutExt = displayName.substring(0, displayName.lastIndexOf('.'));
                displayName = nameWithoutExt.substring(0, 25) + '...' + extension;
            }
            filenameDisplay.textContent = displayName;
            filenameDisplay.style.fontSize = '0.9rem';
            filenameDisplay.style.color = '#28a745';
            filenameDisplay.title = file.name; // Show full name on hover

            // Check file size (5MB limit)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                input.value = '';
                filenameDisplay.textContent = '';
                return;
            }

            // Check file type
            if (!file.type.match('image.*')) {
                alert('Please select a valid image file');
                input.value = '';
                filenameDisplay.textContent = '';
                return;
            }

            // Create file reader for preview
            const reader = new FileReader();
            reader.onload = function (e) {
                // Find the current profile picture image
                let profileImg = previewContainer.querySelector('.profile-pic-img');

                if (profileImg.tagName === 'IMG') {
                    // If it's already an img element, just update the src
                    profileImg.src = e.target.result;
                } else {
                    // If it's a span (placeholder), replace with img
                    const newImg = document.createElement('img');
                    newImg.src = e.target.result;
                    newImg.alt = 'Profile Picture Preview';
                    newImg.className = 'rounded-circle mb-3 profile-pic-img';
                    newImg.style.cssText = 'width: 120px; height: 120px; object-fit: cover;';

                    // Replace the span with the new img
                    profileImg.parentNode.replaceChild(newImg, profileImg);
                }

                // Refresh CSRF token to prevent token mismatch errors
                refreshCSRFToken();

                // Show a success message
                showMessage('Profile picture preview updated! Don\'t forget to save changes.', 'success');
            };
            reader.readAsDataURL(file);
        } else {
            filenameDisplay.textContent = '';
        }
    }

    // Function to refresh CSRF token
    function refreshCSRFToken() {
        // Fetch a fresh CSRF token
        fetch('/api/get-csrf-token', {
            method: 'GET',
            credentials: 'same-origin'
        })
            .then(response => response.json())
            .then(data => {
                if (data.csrf_token) {
                    // Update the hidden CSRF token field
                    const csrfInput = document.getElementById('csrf-token-input');
                    if (csrfInput) {
                        csrfInput.value = data.csrf_token;
                    }

                    // Update any other CSRF token fields in the page
                    const allCsrfInputs = document.querySelectorAll('input[name="csrf_token"]');
                    allCsrfInputs.forEach(input => {
                        input.value = data.csrf_token;
                    });
                }
            })
            .catch(error => {
                console.log('Note: Could not refresh CSRF token automatically. If you encounter a security token mismatch, please refresh the page.');
            });
    }

    // Bio character counter
    document.getElementById('bio').addEventListener('input', function () {
        const bioCount = document.getElementById('bio-count');
        bioCount.textContent = this.value.length;

        if (this.value.length > 450) {
            bioCount.style.color = '#dc3545';
        } else if (this.value.length > 400) {
            bioCount.style.color = '#ffc107';
        } else {
            bioCount.style.color = '#6c757d';
        }
    });

    // Password change form handling
    document.getElementById('changePasswordForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const submitButton = this.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;

        const currentPassword = document.getElementById('current_password').value;
        const newPassword = document.getElementById('new_password').value;
        const confirmPassword = document.getElementById('confirm_password').value;
        const otpCodeField = document.getElementById('password_otp_code');
        const otpCode = otpCodeField ? otpCodeField.value : '';

        // Client-side validation
        if (newPassword !== confirmPassword) {
            alert('New passwords do not match!');
            return;
        }

        if (newPassword.length < 6) {
            alert('New password must be at least 8 characters long!');
            return;
        }

        // Check if OTP is required but not provided
        if (isOtpCurrentlyEnabled() && !otpCode) {
            alert('OTP code is required for password change!');
            return;
        }

        // Show loading state
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing...';
        submitButton.disabled = true;

        // Prepare form data
        const formData = new FormData();
        formData.append('current_password', currentPassword);
        formData.append('new_password', newPassword);
        formData.append('confirm_password', confirmPassword);
        if (otpCode) {
            formData.append('otp_code', otpCode);
        }

        // Submit the form
        csrfFetch('{{ url_for("main.change_password") }}', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Password changed successfully!');
                    // Reset the form and hide it
                    document.getElementById('changePasswordForm').reset();
                    document.getElementById('passwordChangeForm').classList.remove('show');
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while changing password');
            })
            .finally(() => {
                // Restore button state
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            });
    });

    // Send OTP for password change
    const sendPasswordOtpBtn = document.getElementById('sendPasswordOtpBtn');
    if (sendPasswordOtpBtn) {
        sendPasswordOtpBtn.addEventListener('click', function () {
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            this.disabled = true;

            csrfFetch('/api/send-password-change-otp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessage('OTP sent to your email!', 'success');
                    } else {
                        showMessage('Error: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('Failed to send OTP', 'error');
                })
                .finally(() => {
                    this.innerHTML = originalText;
                    this.disabled = false;
                });
        });
    }

    // Password confirmation validation
    document.getElementById('confirm_password').addEventListener('input', function () {
        const newPassword = document.getElementById('new_password').value;
        const confirmPassword = this.value;

        if (confirmPassword && newPassword !== confirmPassword) {
            this.setCustomValidity('Passwords do not match');
        } else {
            this.setCustomValidity('');
        }
    });

    document.getElementById('new_password').addEventListener('input', function () {
        const confirmPassword = document.getElementById('confirm_password');
        if (confirmPassword.value && this.value !== confirmPassword.value) {
            confirmPassword.setCustomValidity('Passwords do not match');
        } else {
            confirmPassword.setCustomValidity('');
        }
    });

    // Delete account form handling
    document.getElementById('deleteAccountForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const submitButton = this.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;

        const password = document.getElementById('delete_password').value;
        const confirmDeletion = document.getElementById('confirm_deletion').value;

        // Final confirmation dialog
        if (!confirm('Are you absolutely sure you want to delete your account? This action cannot be undone!')) {
            return;
        }

        // Show loading state
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
        submitButton.disabled = true;

        // Prepare form data
        const formData = new FormData();
        formData.append('password', password);
        formData.append('confirm_deletion', confirmDeletion);

        // Submit the form
        csrfFetch('{{ url_for("main.delete_account") }}', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Account deleted successfully. You will be redirected to the login page.');
                    // Redirect to login page after successful deletion
                    window.location.href = '{{ url_for("main.login") }}';
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting account');
            })
            .finally(() => {
                // Restore button state (in case of error)
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            });
    });

    // Enable/disable delete button based on confirmation text
    document.getElementById('confirm_deletion').addEventListener('input', function () {
        const deleteBtn = document.getElementById('deleteAccountBtn');
        const password = document.getElementById('delete_password').value;

        if (this.value === 'DELETE' && password.length > 0) {
            deleteBtn.disabled = false;
            deleteBtn.classList.remove('btn-secondary');
            deleteBtn.classList.add('btn-danger');
        } else {
            deleteBtn.disabled = true;
            deleteBtn.classList.remove('btn-danger');
            deleteBtn.classList.add('btn-secondary');
        }
    });

    document.getElementById('delete_password').addEventListener('input', function () {
        const deleteBtn = document.getElementById('deleteAccountBtn');
        const confirmText = document.getElementById('confirm_deletion').value;

        if (this.value.length > 0 && confirmText === 'DELETE') {
            deleteBtn.disabled = false;
            deleteBtn.classList.remove('btn-secondary');
            deleteBtn.classList.add('btn-danger');
        } else {
            deleteBtn.disabled = true;
            deleteBtn.classList.remove('btn-danger');
            deleteBtn.classList.add('btn-secondary');
        }
    });

    // Helper function to check if OTP is currently required
    function isOtpCurrentlyEnabled() {
        const otpToggle = document.getElementById('otpToggle');
        return otpToggle ? otpToggle.checked : {{ 'true' if user.otp_enabled else 'false' }};
    };


    // Helper function to update password OTP section visibility
    function updatePasswordOtpSection() {
        const passwordOtpSection = document.getElementById('passwordOtpSection');
        const otpInput = document.getElementById('password_otp_code');
        const isEnabled = isOtpCurrentlyEnabled();

        if (passwordOtpSection) {
            passwordOtpSection.style.display = isEnabled ? 'block' : 'none';
            if (otpInput) {
                otpInput.required = isEnabled;
                if (!isEnabled) {
                    otpInput.value = ''; // Clear OTP if not required
                }
            }
        }
    }

    // Helper function to show messages (global scope)
    function showMessage(message, type) {
        // Remove existing alerts
        document.querySelectorAll('.alert-temp').forEach(el => el.remove());

        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-temp mt-3`;
        alertDiv.style.position = 'fixed';
        alertDiv.style.top = '20px';
        alertDiv.style.right = '20px';
        alertDiv.style.zIndex = '9999';
        alertDiv.style.minWidth = '300px';
        alertDiv.textContent = message;

        document.body.appendChild(alertDiv);

        // Auto remove after 3 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 3000);
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Add form submission handler for better error handling
        const profileForm = document.getElementById('profileForm');
        if (profileForm) {
            profileForm.addEventListener('submit', function (e) {
                e.preventDefault(); // Prevent default form submission

                const submitButton = this.querySelector('button[type="submit"]');
                const displayNameInput = document.getElementById('display_name');

                if (submitButton) {
                    // Client-side validation
                    const displayName = displayNameInput.value.trim();
                    if (!displayName) {
                        showMessage('Display name cannot be empty.', 'error');
                        return;
                    }

                    if (displayName.length > 50) {
                        showMessage('Display name cannot be longer than 50 characters.', 'error');
                        return;
                    }

                    // Show loading state
                    const originalText = submitButton.innerHTML;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                    submitButton.disabled = true;

                    // Clear any existing error messages
                    document.querySelectorAll('.alert-temp').forEach(el => el.remove());

                    // Create FormData object for the CSRF-protected form submission
                    const formData = new FormData(this);

                    // Submit with CSRF protection and AJAX headers
                    csrfFetch('{{ url_for("main.edit_profile") }}', {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                showMessage('Profile updated successfully!', 'success');
                                // Redirect to profile page after showing success message
                                setTimeout(() => {
                                    window.location.href = '{{ url_for("profile.profile") }}';
                                }, 1500);
                            } else {
                                showMessage(data.error || 'An error occurred while updating your profile.', 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            showMessage('An error occurred while updating your profile. Please try again.', 'error');
                        })
                        .finally(() => {
                            // Restore button state
                            submitButton.innerHTML = originalText;
                            submitButton.disabled = false;
                        });
                }
            });
        }

        // Add real-time validation for display name
        const displayNameInput = document.getElementById('display_name');
        if (displayNameInput) {
            displayNameInput.addEventListener('input', function () {
                const value = this.value.trim();
                const maxLength = 50;

                // Remove any existing validation messages
                const existingError = document.querySelector('.display-name-error');
                if (existingError) {
                    existingError.remove();
                }

                if (value.length > maxLength) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'text-danger small mt-1 display-name-error';
                    errorDiv.textContent = `Display name is too long (${value.length}/${maxLength} characters)`;
                    this.parentNode.appendChild(errorDiv);
                    this.classList.add('is-invalid');
                } else {
                    this.classList.remove('is-invalid');
                }
            });
        }

        // OTP Toggle Handler
        const otpToggle = document.getElementById('otpToggle');
        if (otpToggle) {
            otpToggle.addEventListener('change', function () {
                const isEnabled = this.checked;
                const wasEnabled = {{ 'true' if user.otp_enabled else 'false' }};
            });

            // If disabling MFA, show confirmation dialog
            if (!isEnabled && wasEnabled) {
                const confirmed = confirm(
                    'Are you sure you want to disable Multi-Factor Authentication?\n\n' +
                    'This will make your account less secure. You will only need your password to log in.\n\n' +
                    'Click OK to disable MFA, or Cancel to keep it enabled.'
                );

                if (!confirmed) {
                    // User cancelled, revert toggle
                    this.checked = true;
                    return;
                }
            }

            // Show loading indicator
            const originalLabel = this.nextElementSibling;
            const tempText = document.createElement('small');
            tempText.className = 'text-muted ms-2';
            tempText.textContent = 'Updating...';
            originalLabel.parentNode.appendChild(tempText);

            csrfFetch('/update-otp-setting', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    otp_enabled: isEnabled,
                    confirmation: true  // Always send confirmation since we already asked user
                })
            })
                .then(response => response.json())
                .then(data => {
                    // Remove loading indicator
                    tempText.remove();

                    if (data.success) {
                        // Show success message
                        showMessage(
                            isEnabled ? 'OTP authentication enabled' : 'OTP authentication disabled',
                            'success'
                        );

                        // If disabling OTP, hide/show OTP sections in password form
                        updatePasswordOtpSection();
                    } else {
                        // Revert toggle on error
                        this.checked = !isEnabled;
                        showMessage(data.error || 'Failed to update OTP setting', 'error');
                    }
                })
                .catch(error => {
                    // Remove loading indicator and revert toggle
                    tempText.remove();
                    this.checked = !isEnabled;
                    showMessage('An error occurred while updating OTP setting', 'error');
                });
        });
    }

    const removeBtn = document.getElementById('removeProfilePicBtn');
    if (removeBtn) {
        removeBtn.addEventListener('click', function () {
            csrfFetch('{{ url_for("main.remove_profile_picture") }}', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update the preview to default icon with hover functionality
                        document.querySelector('#profile-pic-preview').innerHTML =
                            `<span class="d-inline-flex align-items-center justify-content-center rounded-circle mb-3 profile-pic-img" style="width: 120px; height: 120px; background: #23263a; color: #bfc7d5; font-size: 2.5rem; border: 2px solid #343a40;"><i class="fas fa-user"></i></span>
                         <span class="change-pic-icon">
                            <i class="fas fa-camera"></i>
                         </span>`;
                        removeBtn.style.display = 'none';
                        // Clear the file input and filename
                        document.getElementById('profile-picture-input').value = '';
                        document.getElementById('profile-pic-filename').textContent = '';
                        showMessage('Profile picture removed successfully!', 'success');
                        // Update on profile page if present
                        const profileImg = document.querySelector('.profile-header-card .rounded-circle');
                        if (profileImg) {
                            profileImg.outerHTML =
                                `<span class=\"d-inline-flex align-items-center justify-content-center rounded-circle me-3\" style=\"width: 64px; height: 64px; background: #23263a; color: #bfc7d5; font-size: 2rem; border: 2px solid #343a40;\"><i class=\"fas fa-user\"></i></span>`;
                        }
                        // Update main-nav profile image if present
                        const navImg = document.querySelector('#main-nav .rounded-circle');
                        if (navImg) {
                            navImg.outerHTML = `<span class=\"d-inline-flex align-items-center justify-content-center rounded-circle\" style=\"width: 40px; height: 40px; background: #23263a; color: #bfc7d5; font-size: 1.3rem; border: 2px solid #343a40;\"><i class=\"fas fa-user\"></i></span>`;
                        }
                    } else {
                        alert(data.message || 'Failed to remove profile picture.');
                    }
                });
        });
    }

    // Email update with OTP handlers
    const sendEmailOtpBtn = document.getElementById('sendEmailOtpBtn');
    const verifyEmailOtpBtn = document.getElementById('verifyEmailOtpBtn');
    const backToEmailInputBtn = document.getElementById('backToEmailInputBtn');
    const resendEmailOtpBtn = document.getElementById('resendEmailOtpBtn');

    if (sendEmailOtpBtn) {
        sendEmailOtpBtn.addEventListener('click', function () {
            const newEmailInput = document.getElementById('new_email');
            const newEmail = newEmailInput.value.trim();
            const currentEmail = document.getElementById('current_email_display').value.trim();

            if (!newEmail) {
                showMessage('Please enter a new email address.', 'error');
                return;
            }

            // Check if new email is same as current email
            if (newEmail.toLowerCase() === currentEmail.toLowerCase()) {
                showMessage('Cannot be same as current email.', 'error');
                return;
            }

            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(newEmail)) {
                showMessage('Please enter a valid email address.', 'error');
                return;
            }

            sendEmailOtpBtn.disabled = true;
            const originalText = sendEmailOtpBtn.innerHTML;
            sendEmailOtpBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

            csrfFetch('/api/send-email-update-otp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ new_email: newEmail })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show OTP verification section
                        document.getElementById('email-input-section').style.display = 'none';
                        document.getElementById('email-otp-section').style.display = 'block';
                        document.getElementById('otp-target-email').textContent = newEmail;
                        showMessage('Verification code sent to your new email!', 'success');
                    } else {
                        showMessage(data.error || 'Failed to send verification code.', 'error');
                    }
                })
                .catch(error => {
                    showMessage('An error occurred while sending verification code.', 'error');
                })
                .finally(() => {
                    sendEmailOtpBtn.disabled = false;
                    sendEmailOtpBtn.innerHTML = originalText;
                });
        });
    }

    if (verifyEmailOtpBtn) {
        verifyEmailOtpBtn.addEventListener('click', function () {
            const newEmail = document.getElementById('new_email').value.trim();
            const otpCode = document.getElementById('email_otp_code').value.trim();

            if (!otpCode) {
                showMessage('Please enter the verification code.', 'error');
                return;
            }

            if (otpCode.length !== 6) {
                showMessage('Incorrect code', 'error');
                return;
            }

            verifyEmailOtpBtn.disabled = true;
            const originalText = verifyEmailOtpBtn.innerHTML;
            verifyEmailOtpBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';

            csrfFetch('/api/verify-email-update-otp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    new_email: newEmail,
                    otp_code: otpCode
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessage('Email updated successfully!', 'success');

                        // Update the readonly email field in the main form
                        const editEmailInput = document.getElementById('edit_email');
                        if (editEmailInput) {
                            editEmailInput.value = data.new_email;
                        }
                        // Update the modal's current email display
                        const currentEmailDisplay = document.getElementById('current_email_display');
                        if (currentEmailDisplay) {
                            currentEmailDisplay.value = data.new_email;
                        }
                        // Reset modal state
                        resetEmailModal();

                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('updateEmailModal'));
                        if (modal) {
                            modal.hide();
                        }
                    } else {
                        showMessage(data.error || 'Failed to verify code.', 'error');
                    }
                })
                .catch(error => {
                    showMessage('An error occurred during verification.', 'error');
                })
                .finally(() => {
                    verifyEmailOtpBtn.disabled = false;
                    verifyEmailOtpBtn.innerHTML = originalText;
                });
        });
    }

    if (backToEmailInputBtn) {
        backToEmailInputBtn.addEventListener('click', function () {
            // Go back to email input section
            document.getElementById('email-otp-section').style.display = 'none';
            document.getElementById('email-input-section').style.display = 'block';
            document.getElementById('email_otp_code').value = '';
        });
    }

    if (resendEmailOtpBtn) {
        resendEmailOtpBtn.addEventListener('click', function () {
            const newEmail = document.getElementById('new_email').value.trim();

            resendEmailOtpBtn.disabled = true;
            const originalText = resendEmailOtpBtn.innerHTML;
            resendEmailOtpBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

            csrfFetch('/api/send-email-update-otp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ new_email: newEmail })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessage('Verification code resent!', 'success');
                        document.getElementById('email_otp_code').value = '';
                    } else {
                        showMessage(data.error || 'Failed to resend code.', 'error');
                    }
                })
                .catch(error => {
                    showMessage('An error occurred while resending code.', 'error');
                })
                .finally(() => {
                    resendEmailOtpBtn.disabled = false;
                    resendEmailOtpBtn.innerHTML = originalText;
                });
        });
    }

    // Function to reset modal state
    function resetEmailModal() {
        document.getElementById('email-input-section').style.display = 'block';
        document.getElementById('email-otp-section').style.display = 'none';
        document.getElementById('new_email').value = '';
        document.getElementById('email_otp_code').value = '';
    }

    // Reset modal when it's closed
    const updateEmailModal = document.getElementById('updateEmailModal');
    if (updateEmailModal) {
        updateEmailModal.addEventListener('hidden.bs.modal', resetEmailModal);
    }
});
</script>
{% endblock %}