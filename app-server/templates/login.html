<!DOCTYPE html>
<html lang="en">
  <head>
    {% with title='Login' %} {% include 'includes/head.html' %} {% endwith %}
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='assets/css/auth.css') }}"
    />
  </head>
  <body>
    <!-- Logo -->
    <div class="logo">Later<span class="beau">G</span>ram</div>

    <!-- Login Form -->
    <div class="container form-container">
      <form method="POST" action="{{ url_for('login') }}">
        <!-- Email Field -->
        <div class="mb-4 login-text-field">
          <label for="email" class="form-label">Email</label>
          <input type="email" class="form-control" id="email" name="email" placeholder="Your email" required/>
        </div>

        <!-- Password Field -->
        <div class="mb-4 login-text-field">
          <label for="password" class="form-label">Password</label>
          <div id="password-input-group" class="input-group">
            <input type="password" class="form-control" id="password" name="password" placeholder="Your password" required/>
            <span class="input-group-text" id="toggle-password" style="cursor: pointer">
              <i class="fa-regular fa-eye" id="toggle-icon"></i>
            </span>
          </div>

          <a href="{{ url_for('reset_password2') }}" id="forget-password" style="color: var(--color-secondary-text); margin-top: 10px; display: block;">Forget Password?</a>
        </div>

        {% include 'otp.html' %}

        <!-- Google reCAPTCHA (hidden-initially)-->
        <div id="captcha-container" class="d-flex d-none justify-content-center">
           <div class="g-recaptcha" data-sitekey="6LdiSG8rAAAAAJKJYfIl48jO3lg-D9wmVpzSHlJX"  data-callback="onCaptchaVerified"></div>
        </div>

        <!-- Login and Reset Buttons -->
        <div class="d-grid my-4 login-btn-wrapper">
          <button type="submit" id="login-btn" name="login-btn" class="btn btn-login">Login</button>
          </div>
              <div class="d-grid mb-4 otp-btn-wrapper" style="display: none">
              <button type="button" class="btn btn-login" id="verify-otp-btn">Verify Code
              </button>
          </div>

        <!-- Sign Up Link -->
        <p id="signup-link">
          Don't have an account?
          <a href="{{ url_for('register') }}" style="color: var(--color-primary)">Sign Up</a>
        </p>
      </form>
      
      <!-- Flash Messages -->
      {% with messages = get_flashed_messages(with_categories=True) %} {% if
      messages %} {% for category, message in messages %}
      <div
        class="alert {% if category == 'success' %}alert-success{% else %}alert-danger{% endif %} mt-3">
        {{ message }}
      </div>
      {% endfor %} {% endif %} {% endwith %}
    </div>

    <!-- Scripts -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
      crossorigin="anonymous"></script>

    <script src="{{ url_for('static', filename='assets/js/auth.js') }}"></script>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <script src="{{ url_for('static', filename='assets/js/captcha.js') }}"></script>
    <script>
      let captchaWidgetId = null;
      let captchaToken = null;
      const captchaContainer = document.querySelector("#captcha-container");
        document.addEventListener("DOMContentLoaded", function () {
            showSection("login");
        });

      function showSection(sectionClass) {
          // Hide all form sections
          document.querySelectorAll(".login-text-field, .otp-text-field").forEach(function (el) {
            el.style.display = "none";
          });
          document.querySelector("#signup-link").style.display = "none";

          // Hide all button wrappers
          document.querySelectorAll(".login-btn-wrapper, .otp-btn-wrapper").forEach(function (el) {
            el.style.display = "none";
          });

          // Hide all individual buttons
          document.querySelectorAll("#login-btn, #verify-otp-btn").forEach(function (el) {
            el.style.display = "none";
          });

          // Show specific section and its corresponding button
          if (sectionClass === "login") {
            document.querySelectorAll(".login-text-field").forEach(function (el) {
              el.style.display = "block";
            });
            document.querySelector(".login-btn-wrapper").style.display = "block";
            document.querySelector("#login-btn").style.display = "block";
            document.querySelector("#signup-link").style.display = "block";
            document.querySelector("#captcha-container").style.display = "block";
            document.getElementById("captcha-container").classList.remove("d-none");
          } else if (sectionClass === "otp") {
              if (captchaContainer) {
                captchaContainer.classList.add("d-none");
              }
              document.querySelector(".otp-text-field").style.display = "block";
              document.querySelector(".otp-btn-wrapper").style.display = "block";
              document.querySelector("#verify-otp-btn").style.display = "block";
          }
      }
    
      // Login form submission
      document.querySelector("form").addEventListener("submit", function (e) {
        const loginWrapper = document.querySelector(".login-btn-wrapper");
        if (loginWrapper && loginWrapper.style.display !== "none") {
          e.preventDefault();

          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;

          fetch("/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              email: email,
              password: password,
              action: "login",
              "g-recaptcha-response": captchaToken,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success && data.requires_otp) {
                // OTP flow enabled for this user or moderator
                document.getElementById("otp-email").value = data.email;
                document.getElementById("otp-type").value = "login";
                showSection("otp");
                showMessage("OTP sent to your email", "success");
              } else if (data.success) {
                // Normal login flow or redirect provided
                if (data.redirect) {
                  window.location.href = data.redirect;
                } else if (data.login_type === "moderator") {
                  window.location.href = "/moderation";
                } else {
                  window.location.href = "/home";
                }
              } else {
                showMessage(data.error, "error");
              }
            })
            .catch((error) => {
              showMessage("An error occurred", "error");
            });
        }
      });

      // Verify OTP
      document.getElementById("verify-otp-btn").addEventListener("click", function () {
          const otpCode = document.getElementById("otp-code").value;
          const email = document.getElementById("otp-email").value;
          const otpType = document.getElementById("otp-type").value;

          // !!! Validate backend 
          // if (!otpCode || otpCode.length !== 6) {
          //   showMessage("Please enter a valid 6-digit code", "error");
          //   return;
          // }

          if (otpType === "login") {
            // Try user login OTP verification first
            fetch("/verify-login-otp", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                email: email,
                otp_code: otpCode,
              }),
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  window.location.href = "/home";
                } else {
                  // If user verification fails, try moderator verification
                  fetch("/verify-moderator-login-otp", {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                      email: email,
                      otp_code: otpCode,
                    }),
                  })
                    .then((response) => response.json())
                    .then((data) => {
                      if (data.success) {
                        window.location.href = "/moderation";
                      } else {
                        showMessage("Invalid or expired OTP", "error");
                      }
                    })
                    .catch((error) => {
                      showMessage("An error occurred", "error");
                    });
                }
              })
              .catch((error) => {
                showMessage("An error occurred", "error");
              });
          }
        });

      // Resend OTP
      document.getElementById("resend-otp").addEventListener("click", function (e) {
          e.preventDefault();
          const email = document.getElementById("otp-email").value;
          const otpType = document.getElementById("otp-type").value;
          if (otpType === "login") {
            // For login OTP, try user first, then moderator
            fetch("/resend-login-otp", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                email: email,
              }),
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  showMessage("New code sent to your email", "success");
                } else {
                  // Try moderator resend
                  fetch("/resend-moderator-login-otp", {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                      email: email,
                    }),
                  })
                    .then((response) => response.json())
                    .then((data) => {
                      if (data.success) {
                        showMessage("New code sent to your email", "success");
                      } else {
                        showMessage("Unable to resend OTP", "error");
                      }
                    })
                    .catch((error) => {
                      showMessage("An error occurred", "error");
                    });
                }
              })
              .catch((error) => {
                showMessage("An error occurred", "error");
              });
          } else if (otpType === "moderator_password_reset") {
            fetch("/moderator-forgot-password", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                email: email,
              }),
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  showMessage("New code sent to your email", "success");
                } else {
                  showMessage(data.error, "error");
                }
              })
              .catch((error) => {
                showMessage("An error occurred", "error");
              });
          } else {
            // User password reset
            fetch("/forgot-password", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                email: email,
              }),
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  showMessage("New code sent to your email", "success");
                } else {
                  showMessage(data.error, "error");
                }
              })
              .catch((error) => {
                showMessage("An error occurred", "error");
              });
          }
        });

      // Show message function
      function showMessage(message, type) {
        // Remove existing messages
        document.querySelectorAll(".alert").forEach(function (el) {
          el.remove();
        });

        const alertDiv = document.createElement("div");
        alertDiv.className = `alert ${
          type === "success" ? "alert-success" : "alert-danger"
        } mt-3`;
        alertDiv.textContent = message;

        document.querySelector(".form-container").appendChild(alertDiv);

        // Remove after 5 seconds
        setTimeout(function () {
          alertDiv.remove();
        }, 5000);
      }
    </script>
  </body>
</html>
