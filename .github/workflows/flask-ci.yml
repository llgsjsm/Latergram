name: Flask CI for Dev Branches

on:
  push:
    branches:
      - dev-release-*
    paths:
      - 'app-server/**'
  pull_request:
    branches:
      - dev-release-*

jobs:
  flask-docker:
    runs-on: ubuntu-latest-xl
    name: Flask Container Tests

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Install Docker Compose
      run: |
        sudo apt-get update
        sudo apt-get install -y docker-compose

    - name: Build Flask Container
      run: docker-compose -f docker-compose.ci.yml up -d --build flask nginx mysqldb

    - name: Run Flask Test
      run: docker exec flask python /app/tests/test_basic_nonginx.py

    - name: Check Flask via NGINX
      run: curl -v --fail http://localhost:80/login || (echo "Flask app failed!" && exit 1)

    # This shit too strict LMAO
    # - name: Lint Flask App in Container
    #   run: docker exec flask flake8 /app

    - name: Teardown
      if: always()
      run: docker-compose -f docker-compose.ci.yml down -v
